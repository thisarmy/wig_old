(function(a){function k(a){var b=["script","iframe","object","embed","param","style","link","form","noscript","param"],c="";for(var d in b){var e=b[d];c+="|((<)("+e+"))",c+="|((</)("+e+")(>))"}return a.replace(new RegExp(c.substr(1),"gi"),function(){return arguments[0].indexOf("</")==0?arguments[0].toLowerCase().replace("</","</REPLACEME"):arguments[0].toLowerCase().replace("<","<REPLACEME")})}function j(a){var b=["script","iframe","object","embed","param","style","link","form","noscript","param"],c="";for(var d in b){var e=b[d];c+="|((<)(replaceme)("+e+"))",c+="|((</)(replaceme)("+e+")(>))"}a=a.replace("<widget>",""),a=a.replace("</widget>","");return a.replace(new RegExp(c.substr(1),"gi"),function(){return arguments[0].toLowerCase().replace("replaceme","")})}var b=["a","abbr","address","area","audio","bm","cite","code","del","details","dfn","command","datalist","em","font","i","iframe","img","input","ins","kbd","label,","legend,","link,","mark,","meter,","nav,","optgroup,","option,","q,","small,","select,","source,","span,","strong,","sub,","summary,","sup,","tbody,","td,","time,","var"],c=["article","aside","blockquote","body","br","button","canvas","caption","col","colgroup","dd","div","dl","dt","embed","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","header","hgroup","hr","li","map","object","ol","output","p","pre","progress","section","table","tbody","textarea","tfoot","th","thead","tr","ul","video"],d=b.concat(c),e=["a","b","i"],f=["p","ul","ol","li","h1","h2","h3","h4","h5","h6"],g=e.concat(f).concat("br"),h=e.concat(["br","img"]),i=h.concat(["li"]);a.fn.looksEmpty=function(){var b=this[0];if(!b)return!0;if(!b.childNodes.length)return!0;if(b.childNodes.length==1){var c=b.childNodes[0].tagName;c&&(c=c.toLowerCase());if(c=="br")return!0;if(b.childNodes[0].nodeType==3&&a.trim(b.childNodes[0].nodeValue)=="")return!0}return!1},a.fn.fillEmptyBlocks=function(){var b=["p","li","h1","h2","h3","h4","h5","h6"].join(",");this.each(function(){var c=a(this);c.find(b).each(function(){var b=a(this);b.looksEmpty()&&b.html('<br class="GENTICS_ephemera">')})})},a.fn.explicitlyNotContenteditable=function(){var a=this.attr("contenteditable");return a=="false"||a==!1},a.fn.cleanup=function(b){var c=a.extend({reservedClasses:".editable",dodgyElements:null,stripUnknown:!1},b);this.each(function(){var b=a(this);c.reservedClasses&&b.find(c.reservedClasses).removeAttr("class"),c.dodgyElements&&b.find(c.dodgyElements).remove(),c.stripUnknown&&(b.find("meta").remove(),b.contents().each(function(){this.nodeType==8&&a(this).remove()}),b.find("strong").each(function(){var b=a(this),c=a("<b></b>");c.html(b.html()),b.after(c).remove()}),b.find("em").each(function(){var b=a(this),c=a("<i></i>");c.html(b.html()),b.after(c).remove()}));if(c.stripUnknown){b.find("*").each(function(){var b=a(this),c=this.tagName.toLowerCase();b.removeAttr("style"),b.removeAttr("id");if(c=="img"){var d=b,e=d.parent("a");if(!e.length){var f="left";d.hasClass("left")&&(f="left"),d.hasClass("right")&&(f="right"),d.hasClass("center")&&(f="center"),d.removeAttr("class"),d.addClass(f)}}else if(c=="a"){var e=a(this),f;e.hasClass("img-left")&&(f="img-left"),e.hasClass("img-right")&&(f="img-right"),e.hasClass("img-center")&&(f="img-center"),e.removeAttr("class"),f&&e.addClass(f)}else if(c=="br"){var g=a(this);g.hasClass("GENTICS_ephemera")?g.removeAttr("class").addClass("GENTICS_ephemera"):g.removeAttr("class")}else a(this).removeAttr("class")});var d=["div","font","span"].concat(f),e=[];for(var g in d)e.push(d[g]+":empty");var h=e.join(",");b.find(h).remove(),b.find("div,font,span").contents().unwrap()}b.containsKnownBlockElements()&&b.find("> br").remove(),c.validImageDomains&&b.find("img").each(function(){var b=a(this),d=b.attr("src");d.indexOf("http://")==0&&(d=d.substr("http://".length)),d.indexOf("https://")==0&&(d=d.substr("https://".length)),d=d.split("/")[0];if(a.inArray(d,c.validImageDomains)==-1){var e=b.parent("a");e.length?e.remove():b.remove()}}),b.fillEmptyBlocks()});return this},a.fn.unknownToCode=function(b){var c=a.extend({blockClasses:"code block-code",inlineClasses:"code inline-code"},b);this.each(function(){var b=a(this),d=[];for(var e in f)d.push("> "+f[e]);b.find(d.join(", ")).each(function(){a(this).find("*").each(function(){var b=this.tagName.toLowerCase();a.inArray(b,i)==-1&&(a(this).contents().length==0?a(this).remove():a(this).contents().unwrap())})});var h=[],k=b.contents();for(var e=0;e<k.length;e++){var l=k[e];if(l.nodeType==1){var m=l.nodeName.toLowerCase();a.inArray(m,g)==-1?h.length&&a.isArray(h[h.length-1])?h[h.length-1].push(l):h.push([l]):h.push(l)}else h.push(l)}var n=a("<div></div>"),o;for(var e=0;e<h.length;e++)if(a.isArray(h[e])){var p="";for(var q=0;q<h[e].length;q++)o=a("<div></div>").append(a(h[e][q]).clone()).remove().html(),o=j(o),o=o.replace(/</g,"&lt;").replace(/>/g,"&gt;")+"\n",p+=o;var r=a('<div class="'+c.blockClasses+'"></div>');r.contentEditable(!1),r.append("<textarea>"+p+"</textarea>"+'<div class="wig-add-paragraphs">'+'<span class="wig-add-above" title="Insert paragraph above this block.">↑</span>'+'<span class="wig-add-below" title="Insert paragraph below this block.">↓</span>'+"</div>"),n.append(r)}else n.append(a(h[e]).clone());b.html(n.remove().html())});return this},a.fn.containsKnownBlockElements=function(){var b=["> widget","> div"];for(var c in f)b.push("> "+f[c]);return a(this).find(b.join(", ")).length>0},a.fn.forceParagraphs=function(){this.each(function(){var b=a(this),c=[],d=b.contents();for(var e=0;e<d.length;e++){var f=d[e];if(f.nodeType==3)c.length&&a.isArray(c[c.length-1])?c[c.length-1].push(f):c.push([f]);else if(f.nodeType==1){var g=f.nodeName.toLowerCase();a.inArray(g,h)!=-1?c.length&&a.isArray(c[c.length-1])?c[c.length-1].push(f):c.push([f]):c.push(f)}else c.push(f)}var i=a("<div></div>"),j;for(var e=0;e<c.length;e++)if(a.isArray(c[e])){var k="";for(var l=0;l<c[e].length;l++){var f=c[e][l];if(f.nodeType==1){var j=a("<div></div>").append(a(f).clone()).remove().html();k+=j}else k+=f.nodeValue}a.trim(k)&&i.append("<p>"+k+"</p>")}else i.append(a(c[e]).clone());b.html(i.remove().html())});return this},a.fn.wrapImages=function(){this.each(function(){var b="a.img-left,a.img-center,a.img-right,img.left,img.center,img.right";a(this).find(b).each(function(){var b=a(this),c;if(b.hasClass("img-left")||b.hasClass("left"))c="img-left";else if(b.hasClass("img-right")||b.hasClass("right"))c="img-right";else if(b.hasClass("img-center")||b.hasClass("center"))c="img-center";if(c){b.removeAttr("class");var d=b.find("img");d.length?d.removeAttr("class"):d=b,b.wrap('<div class="wig-imgwrap '+c+'"></div>'),$wrap=b.parents(".wig-imgwrap"),$wrap.contentEditable(!1),$wrap.width(d.width())}})});return this},a.fn.serializeWithoutCode=function(){var b={},c=1;this.find("textarea").each(function(){var d="textarea-"+c;a(this).attr("id",d),b[d]=a(this).val(),c+=1});var d=this.clone(!0),e=1,g={};d.find(".wig-block-code").each(function(){var c=a(this),d=b[c.find("textarea").attr("id")],f="___"+e+"___";g[f]=k(d),c.html(f),c.contents().unwrap(),e+=1}),d.find(".wig-imgwrap").each(function(){var b=a(this),c="left",d="";b.find(">a").length&&(d="img-"),b.hasClass("img-right")&&(c="right"),b.hasClass("img-center")&&(c="center"),b.find(">*").addClass(d+c),b.contents().unwrap()}),d.find("br.GENTICS_ephemera, img + br").remove(),d.find("*").each(function(){var b=a(this);try{b.removeAttr("contentEditable"),b.removeAttr("contenteditable")}catch(c){}var d=b.attr("class").split(" ");for(var e in d){var f=d[e];f.indexOf("wig-")==0&&b.removeClass(f),f.indexOf("GENTICS_")==0&&b.removeClass(f)}b.attr("class")||b.removeAttr("class")});var h=[];for(var i in f)h.push(f[i]+":empty");var j=h.join(",");d.find(j).remove();var l=d.html();for(var m in g)l=l.replace(m,g[m]);return l.replace(/REPLACEME/g,"").replace(/<widget>/g,"").replace(/<\/widget>/g,"")},a.fn.handleCodeTextarea=function(){this.each(function(){a(this).keydown(function(a){GENTICS.Aloha.activeEditable.eventHandled=!1,a.stopPropagation()}).blur(function(){var b=a(this);a.trim(b.val())==""&&b.parents(".wig-block-code").remove()}).contentEditable(!0)});return this}})(jQuery)